var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
define(["require", "exports", "Models", "StatusViews"], function (require, exports, models, statusViews) {
    var bb = Backbone;
    var ViewSate;
    (function (ViewSate) {
        ViewSate[ViewSate["View"] = 0] = "View";
        ViewSate[ViewSate["Add"] = 1] = "Add";
        ViewSate[ViewSate["Edit"] = 2] = "Edit";
    })(ViewSate || (ViewSate = {}));
    ;
    // view of products with their lines, operation status info
    var ProductStatusViewList = (function (_super) {
        __extends(ProductStatusViewList, _super);
        function ProductStatusViewList() {
            this.collection = models.Collections().Products;
            // collection changes
            models.Collections().Products.on('add', this.render, this);
            models.Collections().Products.on('remove', this.render, this);
            models.Collections().Lines.on('add', this.render, this);
            models.Collections().Lines.on('remove', this.render, this);
            models.Collections().Statuses.on('add', this.render, this);
            models.Collections().Statuses.on('remove', this.render, this);
            models.Collections().Operations.on('add', this.render, this);
            models.Collections().Operations.on('remove', this.render, this);
            models.Collections().Products.on('sync', this.render, this);
            _super.call(this);
        }
        ProductStatusViewList.prototype.render = function () {
            var _this = this;
            this.$el.html('');
            this.collection.each(function (p) {
                var psv = new ProductStatusView(p);
                _this.$el.append(psv.render().el);
            }, this);
            return this;
        };
        return ProductStatusViewList;
    })(bb.View);
    exports.ProductStatusViewList = ProductStatusViewList;
    // list item
    var ProductStatusView = (function (_super) {
        __extends(ProductStatusView, _super);
        function ProductStatusView(model) {
            this.model = model;
            this.template = _.template($('#productStatusView-template').html());
            _super.call(this);
        }
        ProductStatusView.prototype.render = function () {
            var _this = this;
            this.$el.html(this.template({
                id: this.model.id,
                Name: this.model.Name
            }));
            this.model.Lines.forEach(function (line) {
                var ml = models.Collections().Lines.get(line.LineId);
                var pslv = new ProductStatusLineView(_this.model.id, ml);
                _this.$el.find('div[class=operations]').append(pslv.render().$el);
            }, this);
            return this;
        };
        return ProductStatusView;
    })(bb.View);
    exports.ProductStatusView = ProductStatusView;
    // items line
    var ProductStatusLineView = (function (_super) {
        __extends(ProductStatusLineView, _super);
        function ProductStatusLineView(productId, model) {
            this.productId = productId;
            this.model = model;
            this.template = _.template($('#productStatusLineView-template').html());
            _super.call(this);
        }
        ProductStatusLineView.prototype.render = function () {
            var _this = this;
            this.$el.html(this.template(this.model.toJSON()));
            var operations = models.Collections().Operations.filter(function (o) { return o.LineId == _this.model.id; });
            operations.forEach(function (o) {
                var psov = new ProductStatusOperationView(_this.productId, o.LineId);
                psov.model = o;
                _this.$el.find('div[class=operationView]').append(psov.render().$el);
            }, this);
            return this;
        };
        return ProductStatusLineView;
    })(bb.View);
    exports.ProductStatusLineView = ProductStatusLineView;
    // items lines operation
    var ProductStatusOperationView = (function (_super) {
        __extends(ProductStatusOperationView, _super);
        function ProductStatusOperationView(productId, lineId) {
            this.state = ViewSate.View;
            this.productId = productId;
            this.lineId = lineId;
            this.template = _.template($('#productStatusOperationView-template').html());
            _super.call(this);
        }
        ProductStatusOperationView.prototype.render = function () {
            var _this = this;
            var statues = models.Collections().Statuses.filter(function (s) { return s.ProductId == _this.productId && s.OperationId == _this.model.id; });
            var sv = new statusViews.StatusView(this.productId, this.model.id);
            if (statues.length > 0) {
                sv.model = statues[0];
            }
            else {
                sv.model = null;
            }
            this.$el.html(this.template({ "Name": this.model.Name }));
            this.$el.find('div[class=operationState]').append(sv.render().$el);
            return this;
        };
        return ProductStatusOperationView;
    })(bb.View);
    exports.ProductStatusOperationView = ProductStatusOperationView;
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlByb2plY3RTdGF0dXNWaWV3cy50cyJdLCJuYW1lcyI6WyJWaWV3U2F0ZSIsIlByb2R1Y3RTdGF0dXNWaWV3TGlzdCIsIlByb2R1Y3RTdGF0dXNWaWV3TGlzdC5jb25zdHJ1Y3RvciIsIlByb2R1Y3RTdGF0dXNWaWV3TGlzdC5yZW5kZXIiLCJQcm9kdWN0U3RhdHVzVmlldyIsIlByb2R1Y3RTdGF0dXNWaWV3LmNvbnN0cnVjdG9yIiwiUHJvZHVjdFN0YXR1c1ZpZXcucmVuZGVyIiwiUHJvZHVjdFN0YXR1c0xpbmVWaWV3IiwiUHJvZHVjdFN0YXR1c0xpbmVWaWV3LmNvbnN0cnVjdG9yIiwiUHJvZHVjdFN0YXR1c0xpbmVWaWV3LnJlbmRlciIsIlByb2R1Y3RTdGF0dXNPcGVyYXRpb25WaWV3IiwiUHJvZHVjdFN0YXR1c09wZXJhdGlvblZpZXcuY29uc3RydWN0b3IiLCJQcm9kdWN0U3RhdHVzT3BlcmF0aW9uVmlldy5yZW5kZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7SUFBQSxJQUFPLEVBQUUsR0FBRyxRQUFRLENBQUM7SUFJckIsSUFBSyxRQUE0QjtJQUFqQyxXQUFLLFFBQVE7UUFBR0EsdUNBQUlBLENBQUFBO1FBQUVBLHFDQUFHQSxDQUFBQTtRQUFFQSx1Q0FBSUEsQ0FBQUE7SUFBQ0EsQ0FBQ0EsRUFBNUIsUUFBUSxLQUFSLFFBQVEsUUFBb0I7SUFBQSxDQUFDO0lBRWxDLEFBQ0EsMkRBRDJEOztRQUNoQkMseUNBQXVCQTtRQUM5REE7WUFDSUMsSUFBSUEsQ0FBQ0EsVUFBVUEsR0FBR0EsTUFBTUEsQ0FBQ0EsV0FBV0EsRUFBRUEsQ0FBQ0EsUUFBUUEsQ0FBQ0E7WUFDaERBLEFBQ0FBLHFCQURxQkE7WUFDckJBLE1BQU1BLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBLFFBQVFBLENBQUNBLEVBQUVBLENBQUNBLEtBQUtBLEVBQUVBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1lBQzNEQSxNQUFNQSxDQUFDQSxXQUFXQSxFQUFFQSxDQUFDQSxRQUFRQSxDQUFDQSxFQUFFQSxDQUFDQSxRQUFRQSxFQUFFQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUM5REEsTUFBTUEsQ0FBQ0EsV0FBV0EsRUFBRUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsS0FBS0EsRUFBRUEsSUFBSUEsQ0FBQ0EsTUFBTUEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDeERBLE1BQU1BLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBLEtBQUtBLENBQUNBLEVBQUVBLENBQUNBLFFBQVFBLEVBQUVBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1lBQzNEQSxNQUFNQSxDQUFDQSxXQUFXQSxFQUFFQSxDQUFDQSxRQUFRQSxDQUFDQSxFQUFFQSxDQUFDQSxLQUFLQSxFQUFFQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUMzREEsTUFBTUEsQ0FBQ0EsV0FBV0EsRUFBRUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsUUFBUUEsRUFBRUEsSUFBSUEsQ0FBQ0EsTUFBTUEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDOURBLE1BQU1BLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBLFVBQVVBLENBQUNBLEVBQUVBLENBQUNBLEtBQUtBLEVBQUVBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1lBQzdEQSxNQUFNQSxDQUFDQSxXQUFXQSxFQUFFQSxDQUFDQSxVQUFVQSxDQUFDQSxFQUFFQSxDQUFDQSxRQUFRQSxFQUFFQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNoRUEsTUFBTUEsQ0FBQ0EsV0FBV0EsRUFBRUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsTUFBTUEsRUFBRUEsSUFBSUEsQ0FBQ0EsTUFBTUEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDNURB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SUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsRUFBRUEsTUFBTUEsRUFBRUEsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDMURBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLENBQUNBLDJCQUEyQkEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7WUFDbkVBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO1FBQ2hCQSxDQUFDQTtRQUNMRixpQ0FBQ0E7SUFBREEsQ0F4QkEsQUF3QkNBLEVBeEIrQyxFQUFFLENBQUMsSUFBSSxFQXdCdEQ7SUF4Qlksa0NBQTBCLDZCQXdCdEMsQ0FBQSIsImZpbGUiOiJQcm9qZWN0U3RhdHVzVmlld3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYmIgPSBCYWNrYm9uZTtcclxuaW1wb3J0IG1vZGVscyA9IHJlcXVpcmUoXCJNb2RlbHNcIik7XHJcbmltcG9ydCBzdGF0dXNWaWV3cyA9IHJlcXVpcmUoXCJTdGF0dXNWaWV3c1wiKTtcclxuXHJcbmVudW0gVmlld1NhdGUgeyBWaWV3LCBBZGQsIEVkaXQgfTtcclxuXHJcbi8vIHZpZXcgb2YgcHJvZHVjdHMgd2l0aCB0aGVpciBsaW5lcywgb3BlcmF0aW9uIHN0YXR1cyBpbmZvXHJcbmV4cG9ydCBjbGFzcyBQcm9kdWN0U3RhdHVzVmlld0xpc3QgZXh0ZW5kcyBiYi5WaWV3PG1vZGVscy5Qcm9kdWN0PiB7XHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLmNvbGxlY3Rpb24gPSBtb2RlbHMuQ29sbGVjdGlvbnMoKS5Qcm9kdWN0cztcclxuICAgICAgICAvLyBjb2xsZWN0aW9uIGNoYW5nZXNcclxuICAgICAgICBtb2RlbHMuQ29sbGVjdGlvbnMoKS5Qcm9kdWN0cy5vbignYWRkJywgdGhpcy5yZW5kZXIsIHRoaXMpO1xyXG4gICAgICAgIG1vZGVscy5Db2xsZWN0aW9ucygpLlByb2R1Y3RzLm9uKCdyZW1vdmUnLCB0aGlzLnJlbmRlciwgdGhpcyk7XHJcbiAgICAgICAgbW9kZWxzLkNvbGxlY3Rpb25zKCkuTGluZXMub24oJ2FkZCcsIHRoaXMucmVuZGVyLCB0aGlzKTtcclxuICAgICAgICBtb2RlbHMuQ29sbGVjdGlvbnMoKS5MaW5lcy5vbigncmVtb3ZlJywgdGhpcy5yZW5kZXIsIHRoaXMpO1xyXG4gICAgICAgIG1vZGVscy5Db2xsZWN0aW9ucygpLlN0YXR1c2VzLm9uKCdhZGQnLCB0aGlzLnJlbmRlciwgdGhpcyk7XHJcbiAgICAgICAgbW9kZWxzLkNvbGxlY3Rpb25zKCkuU3RhdHVzZXMub24oJ3JlbW92ZScsIHRoaXMucmVuZGVyLCB0aGlzKTtcclxuICAgICAgICBtb2RlbHMuQ29sbGVjdGlvbnMoKS5PcGVyYXRpb25zLm9uKCdhZGQnLCB0aGlzLnJlbmRlciwgdGhpcyk7XHJcbiAgICAgICAgbW9kZWxzLkNvbGxlY3Rpb25zKCkuT3BlcmF0aW9ucy5vbigncmVtb3ZlJywgdGhpcy5yZW5kZXIsIHRoaXMpO1xyXG4gICAgICAgIG1vZGVscy5Db2xsZWN0aW9ucygpLlByb2R1Y3RzLm9uKCdzeW5jJywgdGhpcy5yZW5kZXIsIHRoaXMpO1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICB9XHJcbiAgICByZW5kZXIoKTogYmIuVmlldzxtb2RlbHMuUHJvZHVjdD4ge1xyXG4gICAgICAgIHRoaXMuJGVsLmh0bWwoJycpO1xyXG4gICAgICAgIHRoaXMuY29sbGVjdGlvbi5lYWNoKHA9PiB7XHJcbiAgICAgICAgICAgIHZhciBwc3YgPSBuZXcgUHJvZHVjdFN0YXR1c1ZpZXcocCk7XHJcbiAgICAgICAgICAgIHRoaXMuJGVsLmFwcGVuZChwc3YucmVuZGVyKCkuZWwpO1xyXG4gICAgICAgIH0sIHRoaXMpO1xyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG59XHJcbi8vIGxpc3QgaXRlbVxyXG5leHBvcnQgY2xhc3MgUHJvZHVjdFN0YXR1c1ZpZXcgZXh0ZW5kcyBiYi5WaWV3PG1vZGVscy5Qcm9kdWN0PiB7XHJcbiAgICBwcml2YXRlIHRlbXBsYXRlOiAoZGF0YTogYW55KSA9PiBzdHJpbmc7XHJcbiAgICBjb25zdHJ1Y3Rvcihtb2RlbDogbW9kZWxzLlByb2R1Y3QpIHtcclxuICAgICAgICB0aGlzLm1vZGVsID0gbW9kZWw7XHJcbiAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IF8udGVtcGxhdGUoJCgnI3Byb2R1Y3RTdGF0dXNWaWV3LXRlbXBsYXRlJykuaHRtbCgpKTtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgfVxyXG4gICAgcmVuZGVyKCk6IGJiLlZpZXc8bW9kZWxzLlByb2R1Y3Q+IHtcclxuICAgICAgICB0aGlzLiRlbC5odG1sKHRoaXMudGVtcGxhdGUoe1xyXG4gICAgICAgICAgICBpZDogdGhpcy5tb2RlbC5pZCxcclxuICAgICAgICAgICAgTmFtZTogdGhpcy5tb2RlbC5OYW1lXHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIHRoaXMubW9kZWwuTGluZXMuZm9yRWFjaChsaW5lID0+IHtcclxuICAgICAgICAgICAgdmFyIG1sID0gbW9kZWxzLkNvbGxlY3Rpb25zKCkuTGluZXMuZ2V0KGxpbmUuTGluZUlkKTtcclxuICAgICAgICAgICAgdmFyIHBzbHYgPSBuZXcgUHJvZHVjdFN0YXR1c0xpbmVWaWV3KHRoaXMubW9kZWwuaWQsIG1sKTtcclxuICAgICAgICAgICAgdGhpcy4kZWwuZmluZCgnZGl2W2NsYXNzPW9wZXJhdGlvbnNdJykuYXBwZW5kKHBzbHYucmVuZGVyKCkuJGVsKTtcclxuICAgICAgICB9LCB0aGlzKTtcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxufVxyXG4vLyBpdGVtcyBsaW5lXHJcbmV4cG9ydCBjbGFzcyBQcm9kdWN0U3RhdHVzTGluZVZpZXcgZXh0ZW5kcyBiYi5WaWV3PG1vZGVscy5MaW5lPiB7XHJcbiAgICBwcml2YXRlIHByb2R1Y3RJZDogbnVtYmVyO1xyXG4gICAgcHJpdmF0ZSB0ZW1wbGF0ZTogKGRhdGE6IGFueSkgPT4gc3RyaW5nO1xyXG4gICAgY29uc3RydWN0b3IocHJvZHVjdElkOiBudW1iZXIsIG1vZGVsOiBtb2RlbHMuTGluZSkge1xyXG4gICAgICAgIHRoaXMucHJvZHVjdElkID0gcHJvZHVjdElkO1xyXG4gICAgICAgIHRoaXMubW9kZWwgPSBtb2RlbDtcclxuICAgICAgICB0aGlzLnRlbXBsYXRlID0gXy50ZW1wbGF0ZSgkKCcjcHJvZHVjdFN0YXR1c0xpbmVWaWV3LXRlbXBsYXRlJykuaHRtbCgpKTtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgfVxyXG4gICAgcmVuZGVyKCk6IGJiLlZpZXc8bW9kZWxzLkxpbmU+IHtcclxuICAgICAgICB0aGlzLiRlbC5odG1sKHRoaXMudGVtcGxhdGUodGhpcy5tb2RlbC50b0pTT04oKSkpO1xyXG4gICAgICAgIHZhciBvcGVyYXRpb25zID0gbW9kZWxzLkNvbGxlY3Rpb25zKCkuT3BlcmF0aW9ucy5maWx0ZXIobyA9PiBvLkxpbmVJZCA9PSB0aGlzLm1vZGVsLmlkKTtcclxuICAgICAgICBvcGVyYXRpb25zLmZvckVhY2gobyA9PiB7XHJcbiAgICAgICAgICAgIHZhciBwc292ID0gbmV3IFByb2R1Y3RTdGF0dXNPcGVyYXRpb25WaWV3KHRoaXMucHJvZHVjdElkLCBvLkxpbmVJZCk7XHJcbiAgICAgICAgICAgIHBzb3YubW9kZWwgPSBvO1xyXG4gICAgICAgICAgICB0aGlzLiRlbC5maW5kKCdkaXZbY2xhc3M9b3BlcmF0aW9uVmlld10nKS5hcHBlbmQocHNvdi5yZW5kZXIoKS4kZWwpO1xyXG4gICAgICAgIH0sIHRoaXMpO1xyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG59XHJcbi8vIGl0ZW1zIGxpbmVzIG9wZXJhdGlvblxyXG5leHBvcnQgY2xhc3MgUHJvZHVjdFN0YXR1c09wZXJhdGlvblZpZXcgZXh0ZW5kcyBiYi5WaWV3PG1vZGVscy5PcGVyYXRpb24+IHtcclxuICAgIHByaXZhdGUgc3RhdGU6IFZpZXdTYXRlO1xyXG4gICAgcHJpdmF0ZSBwcm9kdWN0SWQ6IG51bWJlcjtcclxuICAgIHByaXZhdGUgbGluZUlkOiBudW1iZXI7XHJcbiAgICBwcml2YXRlIHRlbXBsYXRlOiAoZGF0YTogYW55KSA9PiBzdHJpbmc7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcm9kdWN0SWQ6IG51bWJlciwgbGluZUlkOiBudW1iZXIpIHtcclxuICAgICAgICB0aGlzLnN0YXRlID0gVmlld1NhdGUuVmlldztcclxuICAgICAgICB0aGlzLnByb2R1Y3RJZCA9IHByb2R1Y3RJZDtcclxuICAgICAgICB0aGlzLmxpbmVJZCA9IGxpbmVJZDtcclxuICAgICAgICB0aGlzLnRlbXBsYXRlID0gXy50ZW1wbGF0ZSgkKCcjcHJvZHVjdFN0YXR1c09wZXJhdGlvblZpZXctdGVtcGxhdGUnKS5odG1sKCkpO1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICB9XHJcbiAgICByZW5kZXIoKTogYmIuVmlldzxtb2RlbHMuT3BlcmF0aW9uPiB7XHJcbiAgICAgICAgdmFyIHN0YXR1ZXMgPSBtb2RlbHMuQ29sbGVjdGlvbnMoKS5TdGF0dXNlcy5maWx0ZXIocyA9PiBzLlByb2R1Y3RJZCA9PSB0aGlzLnByb2R1Y3RJZCAmJiBzLk9wZXJhdGlvbklkID09IHRoaXMubW9kZWwuaWQpO1xyXG4gICAgICAgIHZhciBzdiA9IG5ldyBzdGF0dXNWaWV3cy5TdGF0dXNWaWV3KHRoaXMucHJvZHVjdElkLCB0aGlzLm1vZGVsLmlkKTtcclxuICAgICAgICBpZiAoc3RhdHVlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHN2Lm1vZGVsID0gc3RhdHVlc1swXTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzdi5tb2RlbCA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuJGVsLmh0bWwodGhpcy50ZW1wbGF0ZSh7IFwiTmFtZVwiOiB0aGlzLm1vZGVsLk5hbWUgfSkpO1xyXG4gICAgICAgIHRoaXMuJGVsLmZpbmQoJ2RpdltjbGFzcz1vcGVyYXRpb25TdGF0ZV0nKS5hcHBlbmQoc3YucmVuZGVyKCkuJGVsKTtcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxufVxyXG5cclxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9